<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Hakutulokset</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
            cursor: pointer;
        }
        .sort-icon {
            font-size: 12px;
            margin-left: 5px;
            color: #888;
        }
        .map-container {
            width: 90%;
            margin: 20px auto;
        }
        #map {
            height: 600px;
            width: 100%;
        }
        #map.flash {
            box-shadow: 0 0 0 4px rgba(255, 200, 0, 0.6) inset;
            transition: box-shadow 0.6s ease;
        }
    </style>
    {% if show_map %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    {% endif %}
    <script>
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            const rows = Array.from(table.rows).slice(1);
            const ascending = table.getAttribute("data-sort-asc") === "true";

            rows.sort((a, b) => {
                const valA = a.cells[columnIndex].innerText;
                const valB = b.cells[columnIndex].innerText;
                return ascending ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });

            table.setAttribute("data-sort-asc", !ascending);
            rows.forEach(row => table.appendChild(row));
        }
    </script>
</head>
<body>
    <h1>Hakutulokset</h1>

    {% for method, method_results in results.items() %}
        {% if method_results %}
            <h2>{{ method }} ({{ method_results|length }} tulosta)</h2>
            <table id="table_{{ method }}" data-sort-asc="true">
                <thead>
                    <tr>
                        <th onclick="sortTable('table_{{ method }}', 0)">Nimi <span class="sort-icon">ðŸ”½</span></th>
                        <th onclick="sortTable('table_{{ method }}', 1)">Kunta <span class="sort-icon">ðŸ”½</span></th>
                        <th onclick="sortTable('table_{{ method }}', 2)">Kieli <span class="sort-icon">ðŸ”½</span></th>
                        {% if method == "Sumea" %}
                            <th onclick="sortTable('table_{{ method }}', 3)">Samankaltaisuus <span class="sort-icon">ðŸ”½</span></th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for result in method_results %}
                        <tr>
                            <td>
                                {% if show_map and result.get("lat") and result.get("lon") %}
                                    <a href="#map"
                                    onclick="focusMarkerAndScroll('{{ ('%.6f'|format(result['lat'])) }}_{{ ('%.6f'|format(result['lon'])) }}'); return false;">
                                    {{ result["Nimi"] }}
                                    </a>
                                {% else %}
                                    {{ result["Nimi"] }}
                                {% endif %}
                                </td>
                            <td>{{ result["kunta"] }}</td>
                            <td>{{ result["Language"] }}</td>
                            {% if method == "Sumea" %}
                                <td>{{ result["Similarity Score"] }}</td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    {% endfor %}

    {% if not results %}
        <p>Haetuilla metodeilla ei lÃ¶ytynyt mitÃ¤Ã¤n.</p>
    {% endif %}

    {% if show_map %}
        <!-- Leaflet assets -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
    /* optional highlight when jumping to map */
    #map.flash {
        box-shadow: 0 0 0 4px rgba(255, 200, 0, 0.6) inset;
        transition: box-shadow 0.6s ease;
    }
    </style>

    <div class="map-container">
    <div id="map" style="height:600px;width:100%"></div>
    </div>

    <script>
    // Make these global so the table's onclick handlers can use them
    let map;
    const markersByKey = Object.create(null);

    function keyFor(lat, lon) {
        return Number(lat).toFixed(6) + "_" + Number(lon).toFixed(6);
    }

    function scrollToMap() {
        const el = document.getElementById('map');
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        el.classList.add('flash');
        setTimeout(() => el.classList.remove('flash'), 700);
    }

    function focusMarkerAndScroll(key) {
        scrollToMap();

        const m = markersByKey[key];
        if (!m) return;
        const latlng = m.getLatLng();

        // wait a beat for the scroll, then center & open popup
        setTimeout(() => {
        map.invalidateSize(); // if layout changed during scroll

        const targetZoom = Math.max(map.getZoom(), 16);
        map.flyTo(latlng, targetZoom, { animate: true, duration: 0.5 });

        map.once('moveend', () => {
            // open without autoPan so Leaflet doesn't shove the view
            m.openPopup({ autoPan: false });
            // keep the marker centered even with the popup
            setTimeout(() => map.panTo(latlng, { animate: true }), 50);
        });
        }, 350);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // results is provided by Flask render_template(...)
        const results = {{ results | tojson | safe }};

        // Flatten all method arrays into one list
        const all = Object.values(results).flat();

        // Only points with valid numeric lat/lon
        const points = all.filter(p =>
        typeof p.lat === 'number' && typeof p.lon === 'number' &&
        isFinite(p.lat) && isFinite(p.lon)
        );

        if (points.length === 0) {
        // No mappable points: hide map and bail
        const m = document.getElementById('map');
        if (m) m.style.display = 'none';
        console.warn('No mappable points (lat/lon missing or invalid).');
        return;
        }

        // Create the map
        map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Group same coordinates (e.g., suomi/ruotsi at same spot)
        const groups = new Map();
        points.forEach(p => {
        const k = keyFor(p.lat, p.lon);
        if (!groups.has(k)) groups.set(k, { lat: p.lat, lon: p.lon, rows: [] });
        groups.get(k).rows.push(p);
        });

        // Add markers and remember them by key
        const bounds = L.latLngBounds();
        groups.forEach((g, k) => {
        const popupHtml = g.rows.map(e =>
            `<strong>${e.Nimi ?? e.nimi_suomi ?? ''}</strong> (${e.Language ?? ''})<br><em>${e.kunta ?? ''}</em>`
        ).join('<hr>');

        const marker = L.marker([g.lat, g.lon]).addTo(map).bindPopup(popupHtml);
        markersByKey[k] = marker;
        bounds.extend([g.lat, g.lon]);
        });

        // Fit map to show all markers
        map.fitBounds(bounds.pad(0.2));
    });
    </script>


    {% endif %}

    <br>
    <a href="/">Takaisin hakuun</a>
</body>
<script>
  // Always runs, even when show_map is false
  const __results = {{ results | tojson | safe }};
  console.log('RESULTS (always-print):', __results);
</script>
</html>
